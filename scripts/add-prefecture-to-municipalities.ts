/**
 * 既存市区町村データに都道府県コードを付与するスクリプト
 *
 * アプローチ:
 * 1. regions.jsonから駅データの都道府県情報を抽出
 * 2. 市区町村名から都道府県を推定（地名辞書ベース）
 * 3. municipalities.jsonは維持し、regions.jsonに都道府県を追加
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const REGIONS_PATH = path.join(__dirname, '../app/utils/data/regions.json');
const MUNICIPALITIES_PATH = path.join(__dirname, '../app/utils/data/municipalities.json');

interface RegionData {
  romaji: string;
  type: 'municipality' | 'station' | 'area';
  priority: 1 | 2 | 3 | 4 | 5;
  prefecture?: string;
  lat?: number;
  lon?: number;
  lineIds?: string[];
}

// 47都道府県マスターデータ
const PREFECTURE_MAPPING: Record<string, string> = {
  // 北海道
  '北海道': '01', '道央': '01', '道南': '01', '道北': '01', '道東': '01',

  // 東北
  '青森': '02', '岩手': '03', '宮城': '04', '秋田': '05', '山形': '06', '福島': '07',

  // 関東
  '茨城': '08', '栃木': '09', '群馬': '10', '埼玉': '11', '千葉': '12', '東京': '13', '神奈川': '14',

  // 中部
  '新潟': '15', '富山': '16', '石川': '17', '福井': '18', '山梨': '19',
  '長野': '20', '岐阜': '21', '静岡': '22', '愛知': '23',

  // 近畿
  '三重': '24', '滋賀': '25', '京都': '26', '大阪': '27', '兵庫': '28', '奈良': '29', '和歌山': '30',

  // 中国
  '鳥取': '31', '島根': '32', '岡山': '33', '広島': '34', '山口': '35',

  // 四国
  '徳島': '36', '香川': '37', '愛媛': '38', '高知': '39',

  // 九州沖縄
  '福岡': '40', '佐賀': '41', '長崎': '42', '熊本': '43', '大分': '44',
  '宮崎': '45', '鹿児島': '46', '沖縄': '47'
};

// 市区町村名から都道府県を推定
const MUNICIPALITY_PREFECTURE_MAP: Record<string, string> = {
  // 北海道 (01)
  札幌: '01', 函館: '01', 小樽: '01', 旭川: '01', 室蘭: '01', 釧路: '01', 帯広: '01',
  北見: '01', 夕張: '01', 岩見沢: '01', 網走: '01', 留萌: '01', 苫小牧: '01',
  稚内: '01', 美唄: '01', 芦別: '01', 江別: '01', 赤平: '01', 紋別: '01',
  士別: '01', 名寄: '01', 三笠: '01', 根室: '01', 千歳: '01', 滝川: '01',
  砂川: '01', 歌志内: '01', 深川: '01', 富良野: '01', 登別: '01', 恵庭: '01',
  伊達: '01', 北広島: '01', 石狩: '01', 北斗: '01',

  // 青森県 (02)
  青森: '02', 弘前: '02', 八戸: '02', 黒石: '02', 五所川原: '02', 十和田: '02',
  三沢: '02', むつ: '02', つがる: '02', 平川: '02',

  // 岩手県 (03)
  盛岡: '03', 宮古: '03', 大船渡: '03', 花巻: '03', 北上: '03', 久慈: '03',
  遠野: '03', 一関: '03', 陸前高田: '03', 釜石: '03', 二戸: '03', 八幡平: '03',
  奥州: '03', 滝沢: '03',

  // 宮城県 (04)
  仙台: '04', 石巻: '04', 塩竈: '04', 気仙沼: '04', 白石: '04', 名取: '04',
  角田: '04', 多賀城: '04', 岩沼: '04', 登米: '04', 栗原: '04', 東松島: '04',
  大崎: '04', 富谷: '04',

  // 秋田県 (05)
  秋田: '05', 能代: '05', 横手: '05', 大館: '05', 男鹿: '05', 湯沢: '05',
  鹿角: '05', 由利本荘: '05', 潟上: '05', 大仙: '05', 北秋田: '05', にかほ: '05',
  仙北: '05',

  // 山形県 (06)
  山形: '06', 米沢: '06', 鶴岡: '06', 酒田: '06', 新庄: '06', 寒河江: '06',
  上山: '06', 村山: '06', 長井: '06', 天童: '06', 東根: '06', 尾花沢: '06',
  南陽: '06',

  // 福島県 (07)
  福島: '07', 会津若松: '07', 郡山: '07', いわき: '07', 白河: '07', 須賀川: '07',
  喜多方: '07', 相馬: '07', 二本松: '07', 田村: '07', 南相馬: '07', 伊達: '07',
  本宮: '07',

  // 茨城県 (08)
  水戸: '08', 日立: '08', 土浦: '08', 古河: '08', 石岡: '08', 結城: '08',
  龍ケ崎: '08', 下妻: '08', 常総: '08', 常陸太田: '08', 高萩: '08', 北茨城: '08',
  笠間: '08', 取手: '08', 牛久: '08', つくば: '08', ひたちなか: '08', 鹿嶋: '08',
  潮来: '08', 守谷: '08', 常陸大宮: '08', 那珂: '08', 筑西: '08', 坂東: '08',
  稲敷: '08', かすみがうら: '08', 桜川: '08', 神栖: '08', 行方: '08', 鉾田: '08',
  つくばみらい: '08', 小美玉: '08',

  // 栃木県 (09)
  宇都宮: '09', 足利: '09', 栃木: '09', 佐野: '09', 鹿沼: '09', 日光: '09',
  小山: '09', 真岡: '09', 大田原: '09', 矢板: '09', 那須塩原: '09', さくら: '09',
  那須烏山: '09', 下野: '09',

  // 群馬県 (10)
  前橋: '10', 高崎: '10', 桐生: '10', 伊勢崎: '10', 太田: '10', 沼田: '10',
  館林: '10', 渋川: '10', 藤岡: '10', 富岡: '10', 安中: '10', みどり: '10',

  // 埼玉県 (11)
  さいたま: '11', 川越: '11', 熊谷: '11', 川口: '11', 行田: '11', 秩父: '11',
  所沢: '11', 飯能: '11', 加須: '11', 本庄: '11', 東松山: '11', 春日部: '11',
  狭山: '11', 羽生: '11', 鴻巣: '11', 深谷: '11', 上尾: '11', 草加: '11',
  越谷: '11', 蕨: '11', 戸田: '11', 入間: '11', 朝霞: '11', 志木: '11',
  和光: '11', 新座: '11', 桶川: '11', 久喜: '11', 北本: '11', 八潮: '11',
  富士見: '11', 三郷: '11', 蓮田: '11', 坂戸: '11', 幸手: '11', 鶴ヶ島: '11',
  日高: '11', 吉川: '11', ふじみ野: '11', 白岡: '11',

  // 千葉県 (12)
  千葉: '12', 銚子: '12', 市川: '12', 船橋: '12', 館山: '12', 木更津: '12',
  松戸: '12', 野田: '12', 茂原: '12', 成田: '12', 佐倉: '12', 東金: '12',
  旭: '12', 習志野: '12', 柏: '12', 勝浦: '12', 市原: '12', 流山: '12',
  八千代: '12', 我孫子: '12', 鴨川: '12', 鎌ケ谷: '12', 君津: '12', 富津: '12',
  浦安: '12', 四街道: '12', 袖ケ浦: '12', 八街: '12', 印西: '12', 白井: '12',
  富里: '12', 南房総: '12', 匝瑳: '12', 香取: '12', 山武: '12', いすみ: '12',
  大網白里: '12',

  // 東京都 (13)
  千代田: '13', 中央: '13', 港: '13', 新宿: '13', 文京: '13', 台東: '13',
  墨田: '13', 江東: '13', 品川: '13', 目黒: '13', 大田: '13', 世田谷: '13',
  渋谷: '13', 中野: '13', 杉並: '13', 豊島: '13', 北: '13', 荒川: '13',
  板橋: '13', 練馬: '13', 足立: '13', 葛飾: '13', 江戸川: '13',
  八王子: '13', 立川: '13', 武蔵野: '13', 三鷹: '13', 青梅: '13', 府中: '13',
  昭島: '13', 調布: '13', 町田: '13', 小金井: '13', 小平: '13', 日野: '13',
  東村山: '13', 国分寺: '13', 国立: '13', 福生: '13', 狛江: '13', 東大和: '13',
  清瀬: '13', 東久留米: '13', 武蔵村山: '13', 多摩: '13', 稲城: '13', 羽村: '13',
  あきる野: '13', 西東京: '13',

  // 神奈川県 (14)
  横浜: '14', 川崎: '14', 相模原: '14', 横須賀: '14', 平塚: '14', 鎌倉: '14',
  藤沢: '14', 小田原: '14', 茅ヶ崎: '14', 逗子: '14', 三浦: '14', 秦野: '14',
  厚木: '14', 大和: '14', 伊勢原: '14', 海老名: '14', 座間: '14', 南足柄: '14',
  綾瀬: '14',

  // 新潟県 (15)
  新潟: '15', 長岡: '15', 三条: '15', 柏崎: '15', 新発田: '15', 小千谷: '15',
  加茂: '15', 十日町: '15', 見附: '15', 村上: '15', 燕: '15', 糸魚川: '15',
  妙高: '15', 五泉: '15', 上越: '15', 阿賀野: '15', 佐渡: '15', 魚沼: '15',
  南魚沼: '15', 胎内: '15',

  // 富山県 (16)
  富山: '16', 高岡: '16', 魚津: '16', 氷見: '16', 滑川: '16', 黒部: '16',
  砺波: '16', 小矢部: '16', 南砺: '16', 射水: '16',

  // 石川県 (17)
  金沢: '17', 七尾: '17', 小松: '17', 輪島: '17', 珠洲: '17', 加賀: '17',
  羽咋: '17', かほく: '17', 白山: '17', 能美: '17', 野々市: '17',

  // 福井県 (18)
  福井: '18', 敦賀: '18', 小浜: '18', 大野: '18', 勝山: '18', 鯖江: '18',
  あわら: '18', 越前: '18', 坂井: '18',

  // 山梨県 (19)
  甲府: '19', 富士吉田: '19', 都留: '19', 山梨: '19', 大月: '19', 韮崎: '19',
  南アルプス: '19', 北杜: '19', 甲斐: '19', 笛吹: '19', 上野原: '19', 甲州: '19',
  中央: '19',

  // 長野県 (20)
  長野: '20', 松本: '20', 上田: '20', 岡谷: '20', 飯田: '20', 諏訪: '20',
  須坂: '20', 小諸: '20', 伊那: '20', 駒ヶ根: '20', 中野: '20', 大町: '20',
  飯山: '20', 茅野: '20', 塩尻: '20', 佐久: '20', 千曲: '20', 東御: '20',
  安曇野: '20',

  // 岐阜県 (21)
  岐阜: '21', 大垣: '21', 高山: '21', 多治見: '21', 関: '21', 中津川: '21',
  美濃: '21', 瑞浪: '21', 羽島: '21', 恵那: '21', 美濃加茂: '21', 土岐: '21',
  各務原: '21', 可児: '21', 山県: '21', 瑞穂: '21', 飛騨: '21', 本巣: '21',
  郡上: '21', 下呂: '21', 海津: '21',

  // 静岡県 (22)
  静岡: '22', 浜松: '22', 沼津: '22', 熱海: '22', 三島: '22', 富士宮: '22',
  伊東: '22', 島田: '22', 富士: '22', 磐田: '22', 焼津: '22', 掛川: '22',
  藤枝: '22', 御殿場: '22', 袋井: '22', 下田: '22', 裾野: '22', 湖西: '22',
  伊豆: '22', 御前崎: '22', 菊川: '22', 伊豆の国: '22', 牧之原: '22',

  // 愛知県 (23)
  名古屋: '23', 豊橋: '23', 岡崎: '23', 一宮: '23', 瀬戸: '23', 半田: '23',
  春日井: '23', 豊川: '23', 津島: '23', 碧南: '23', 刈谷: '23', 豊田: '23',
  安城: '23', 西尾: '23', 蒲郡: '23', 犬山: '23', 常滑: '23', 江南: '23',
  小牧: '23', 稲沢: '23', 新城: '23', 東海: '23', 大府: '23', 知多: '23',
  知立: '23', 尾張旭: '23', 高浜: '23', 岩倉: '23', 豊明: '23', 日進: '23',
  田原: '23', 愛西: '23', 清須: '23', 北名古屋: '23', 弥富: '23', みよし: '23',
  あま: '23', 長久手: '23',

  // 三重県 (24)
  津: '24', 四日市: '24', 伊勢: '24', 松阪: '24', 桑名: '24', 鈴鹿: '24',
  名張: '24', 尾鷲: '24', 亀山: '24', 鳥羽: '24', 熊野: '24', いなべ: '24',
  志摩: '24', 伊賀: '24',

  // 滋賀県 (25)
  大津: '25', 彦根: '25', 長浜: '25', 近江八幡: '25', 草津: '25', 守山: '25',
  栗東: '25', 甲賀: '25', 野洲: '25', 湖南: '25', 高島: '25', 東近江: '25',
  米原: '25',

  // 京都府 (26)
  京都: '26', 福知山: '26', 舞鶴: '26', 綾部: '26', 宇治: '26', 宮津: '26',
  亀岡: '26', 城陽: '26', 向日: '26', 長岡京: '26', 八幡: '26', 京田辺: '26',
  京丹後: '26', 南丹: '26', 木津川: '26',

  // 大阪府 (27)
  大阪: '27', 堺: '27', 岸和田: '27', 豊中: '27', 池田: '27', 吹田: '27',
  泉大津: '27', 高槻: '27', 貝塚: '27', 守口: '27', 枚方: '27', 茨木: '27',
  八尾: '27', 泉佐野: '27', 富田林: '27', 寝屋川: '27', 河内長野: '27', 松原: '27',
  大東: '27', 和泉: '27', 箕面: '27', 柏原: '27', 羽曳野: '27', 門真: '27',
  摂津: '27', 高石: '27', 藤井寺: '27', 東大阪: '27', 泉南: '27', 四條畷: '27',
  交野: '27', 大阪狭山: '27', 阪南: '27',

  // 兵庫県 (28)
  神戸: '28', 姫路: '28', 尼崎: '28', 明石: '28', 西宮: '28', 洲本: '28',
  芦屋: '28', 伊丹: '28', 相生: '28', 豊岡: '28', 加古川: '28', 赤穂: '28',
  西脇: '28', 宝塚: '28', 三木: '28', 高砂: '28', 川西: '28', 小野: '28',
  三田: '28', 加西: '28', 丹波篠山: '28', 養父: '28', 丹波: '28', 南あわじ: '28',
  朝来: '28', 淡路: '28', 宍粟: '28', 加東: '28', たつの: '28',

  // 奈良県 (29)
  奈良: '29', 大和高田: '29', 大和郡山: '29', 天理: '29', 橿原: '29', 桜井: '29',
  五條: '29', 御所: '29', 生駒: '29', 香芝: '29', 葛城: '29', 宇陀: '29',

  // 和歌山県 (30)
  和歌山: '30', 海南: '30', 橋本: '30', 有田: '30', 御坊: '30', 田辺: '30',
  新宮: '30', 紀の川: '30', 岩出: '30',

  // 鳥取県 (31)
  鳥取: '31', 米子: '31', 倉吉: '31', 境港: '31',

  // 島根県 (32)
  松江: '32', 浜田: '32', 出雲: '32', 益田: '32', 大田: '32', 安来: '32',
  江津: '32', 雲南: '32',

  // 岡山県 (33)
  岡山: '33', 倉敷: '33', 津山: '33', 玉野: '33', 笠岡: '33', 井原: '33',
  総社: '33', 高梁: '33', 新見: '33', 備前: '33', 瀬戸内: '33', 赤磐: '33',
  真庭: '33', 美作: '33', 浅口: '33',

  // 広島県 (34)
  広島: '34', 呉: '34', 竹原: '34', 三原: '34', 尾道: '34', 福山: '34',
  府中: '34', 三次: '34', 庄原: '34', 大竹: '34', 東広島: '34', 廿日市: '34',
  安芸高田: '34', 江田島: '34',

  // 山口県 (35)
  下関: '35', 宇部: '35', 山口: '35', 萩: '35', 防府: '35', 下松: '35',
  岩国: '35', 光: '35', 長門: '35', 柳井: '35', 美祢: '35', 周南: '35',
  山陽小野田: '35',

  // 徳島県 (36)
  徳島: '36', 鳴門: '36', 小松島: '36', 阿南: '36', 吉野川: '36', 阿波: '36',
  美馬: '36', 三好: '36',

  // 香川県 (37)
  高松: '37', 丸亀: '37', 坂出: '37', 善通寺: '37', 観音寺: '37', さぬき: '37',
  東かがわ: '37', 三豊: '37',

  // 愛媛県 (38)
  松山: '38', 今治: '38', 宇和島: '38', 八幡浜: '38', 新居浜: '38', 西条: '38',
  大洲: '38', 伊予: '38', 四国中央: '38', 西予: '38', 東温: '38',

  // 高知県 (39)
  高知: '39', 室戸: '39', 安芸: '39', 南国: '39', 土佐: '39', 須崎: '39',
  宿毛: '39', 土佐清水: '39', 四万十: '39', 香南: '39', 香美: '39',

  // 福岡県 (40)
  北九州: '40', 福岡: '40', 大牟田: '40', 久留米: '40', 直方: '40', 飯塚: '40',
  田川: '40', 柳川: '40', 八女: '40', 筑後: '40', 大川: '40', 行橋: '40',
  豊前: '40', 中間: '40', 小郡: '40', 筑紫野: '40', 春日: '40', 大野城: '40',
  宗像: '40', 太宰府: '40', 古賀: '40', 福津: '40', うきは: '40', 宮若: '40',
  嘉麻: '40', 朝倉: '40', みやま: '40', 糸島: '40', 那珂川: '40',

  // 佐賀県 (41)
  佐賀: '41', 唐津: '41', 鳥栖: '41', 多久: '41', 伊万里: '41', 武雄: '41',
  鹿島: '41', 小城: '41', 嬉野: '41', 神埼: '41',

  // 長崎県 (42)
  長崎: '42', 佐世保: '42', 島原: '42', 諫早: '42', 大村: '42', 平戸: '42',
  松浦: '42', 対馬: '42', 壱岐: '42', 五島: '42', 西海: '42', 雲仙: '42',
  南島原: '42',

  // 熊本県 (43)
  熊本: '43', 八代: '43', 人吉: '43', 荒尾: '43', 水俣: '43', 玉名: '43',
  山鹿: '43', 菊池: '43', 宇土: '43', 上天草: '43', 宇城: '43', 阿蘇: '43',
  天草: '43', 合志: '43',

  // 大分県 (44)
  大分: '44', 別府: '44', 中津: '44', 日田: '44', 佐伯: '44', 臼杵: '44',
  津久見: '44', 竹田: '44', 豊後高田: '44', 杵築: '44', 宇佐: '44', 豊後大野: '44',
  由布: '44', 国東: '44',

  // 宮崎県 (45)
  宮崎: '45', 都城: '45', 延岡: '45', 日南: '45', 小林: '45', 日向: '45',
  串間: '45', 西都: '45', えびの: '45',

  // 鹿児島県 (46)
  鹿児島: '46', 鹿屋: '46', 枕崎: '46', 阿久根: '46', 出水: '46', 指宿: '46',
  西之表: '46', 垂水: '46', 薩摩川内: '46', 日置: '46', 曽於: '46', 霧島: '46',
  いちき串木野: '46', 南さつま: '46', 志布志: '46', 奄美: '46', 南九州: '46',
  伊佐: '46', 姶良: '46',

  // 沖縄県 (47)
  那覇: '47', 宜野湾: '47', 石垣: '47', 浦添: '47', 名護: '47', 糸満: '47',
  沖縄: '47', 豊見城: '47', うるま: '47', 宮古島: '47', 南城: '47',
};

async function main() {
  console.log('🚀 市区町村への都道府県データ付与を開始...\\n');

  // Step 1: regions.json読み込み
  console.log('📂 regions.jsonを読み込み中...');
  const regionsData: Record<string, RegionData> = JSON.parse(
    fs.readFileSync(REGIONS_PATH, 'utf-8')
  );
  console.log(`✅ regions.json読み込み完了: ${Object.keys(regionsData).length}エントリ\\n`);

  // Step 2: municipalities.json読み込み
  console.log('📂 municipalities.jsonを読み込み中...');
  const municipalitiesData: Record<string, string> = JSON.parse(
    fs.readFileSync(MUNICIPALITIES_PATH, 'utf-8')
  );
  console.log(`✅ municipalities.json読み込み完了: ${Object.keys(municipalitiesData).length}エントリ\\n`);

  // Step 3: 市区町村に都道府県を付与
  console.log('🏙️ 市区町村に都道府県データを付与中...');
  let updatedCount = 0;
  let skippedCount = 0;

  for (const [municipalityName, romaji] of Object.entries(municipalitiesData)) {
    // regions.jsonに既に存在するかチェック
    if (regionsData[municipalityName]) {
      const existing = regionsData[municipalityName];

      // 都道府県コードがない場合のみ付与
      if (!existing.prefecture) {
        const prefCode = MUNICIPALITY_PREFECTURE_MAP[municipalityName];
        if (prefCode) {
          regionsData[municipalityName] = {
            ...existing,
            prefecture: prefCode
          };
          updatedCount++;
          console.log(`   ✓ ${municipalityName} → 都道府県コード: ${prefCode}`);
        } else {
          console.warn(`   ⚠️ ${municipalityName} → 都道府県コードが見つかりません`);
          skippedCount++;
        }
      }
    } else {
      // regions.jsonに存在しない場合は新規追加
      const prefCode = MUNICIPALITY_PREFECTURE_MAP[municipalityName];
      if (prefCode) {
        regionsData[municipalityName] = {
          romaji: romaji,
          type: 'municipality',
          priority: 2, // 市区町村は優先度2
          prefecture: prefCode
        };
        updatedCount++;
        console.log(`   + ${municipalityName} → 新規追加 (都道府県: ${prefCode})`);
      } else {
        console.warn(`   ⚠️ ${municipalityName} → 都道府県コードが見つかりません (スキップ)`);
        skippedCount++;
      }
    }
  }

  console.log(`\\n✅ 市区町村データ更新完了:`);
  console.log(`   - 更新/追加: ${updatedCount}件`);
  console.log(`   - スキップ: ${skippedCount}件\\n`);

  // Step 4: regions.jsonを保存
  console.log('💾 regions.jsonを保存中...');
  fs.writeFileSync(
    REGIONS_PATH,
    JSON.stringify(regionsData, null, 2),
    'utf-8'
  );
  console.log(`✅ regions.json保存完了\\n`);

  // Step 5: 統計情報を表示
  console.log('📊 統計情報:');
  const stats = {
    municipality: 0,
    municipalityWithPref: 0,
    station: 0,
    stationWithPref: 0,
  };

  for (const [name, data] of Object.entries(regionsData)) {
    if (data.type === 'municipality') {
      stats.municipality++;
      if (data.prefecture) stats.municipalityWithPref++;
    }
    if (data.type === 'station') {
      stats.station++;
      if (data.prefecture) stats.stationWithPref++;
    }
  }

  console.log(`   市区町村: ${stats.municipality}件`);
  console.log(`   - 都道府県あり: ${stats.municipalityWithPref}件`);
  console.log(`   - 都道府県なし: ${stats.municipality - stats.municipalityWithPref}件`);
  console.log(`   駅: ${stats.station}件`);
  console.log(`   - 都道府県あり: ${stats.stationWithPref}件`);
  console.log('\\n🎉 市区町村への都道府県データ付与が完了しました！');
}

// スクリプト実行
main().catch((error) => {
  console.error('❌ エラーが発生しました:', error);
  process.exit(1);
});
